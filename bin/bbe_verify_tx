#!/usr/bin/env ruby
$:.unshift(File.dirname(__FILE__) + "/../lib")

require 'bitcoin'
require 'open-uri'

tx_hash = ARGV[0]
$testnet = ARGV[1]

def get_tx(hash)
  url = "http://blockexplorer.com/%srawtx/%s" % [$testnet ? 'testnet/' : '',  hash]
  #puts "fetching %s .." % [url]
  json = open(url).read
  Bitcoin::Protocol::Tx.from_json(json)
rescue Exception
  nil
end

tx1 = get_tx(tx_hash)

unless tx1
  puts "Tx #{tx_hash} not found."
  exit
end

if tx1.in.all?{|txin| txin.coinbase? }
  puts "Tx #{tx_hash} is a coinbase transaction. Check the block instead."
  exit
end

tx1.in.each_with_index do |txin, idx|
  if txin.coinbase?
    puts "skipping coinbase transaction input.."; next
  end

  prev_tx = get_tx(txin.previous_output)
  unless prev_tx
    puts "Missing prev_out tx for input #{idx} of tx #{tx_hash}!"
    exit
  end

  result = tx1.verify_input_signature(idx, prev_tx)
  unless result
    puts "Input #{idx} of tx #{tx_hash} is invalid!"
    exit
  end
end

puts "Tx #{tx_hash} is valid."
