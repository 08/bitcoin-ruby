#!/usr/bin/env ruby
$:.unshift( File.expand_path("../../lib", __FILE__) )
require 'eventmachine'
require 'json'
require 'bitcoin'

host, port = "127.0.0.1", 9999
if ARGV[0] == "-s"
  host, port = ARGV[1].split(":")
  ARGV.shift; ARGV.shift
end


EM.run do
  EM.connect(host, port) do |connection|

    connection.send_data([ARGV[0], ARGV[1..-1].join(" ")].to_json)

    def connection.receive_data(data)
      (@buf ||= BufferedTokenizer.new("\x00")).extract(data).each do |packet|
        cmd, result = JSON.load(packet)
        next  unless cmd == ARGV[0]
        if cmd == "monitor"
          type, obj, depth = result
          puts "#{type}: #{obj['hash'] rescue 'none'} #{depth ? "(#{depth})" : ""}"
        else
          puts JSON.pretty_generate(result)
          EM.stop
        end
      end
    end

  end
end
